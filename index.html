<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pittsburgh Water and Sewer Authority: Board Voting Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 30px 40px;
            border-bottom: 4px solid #c0392b;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.85;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 400;
        }
        
        .content {
            padding: 40px 40px;
        }
        
        .intro {
            background: #f9f9f9;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 3px solid #c0392b;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .intro p {
            line-height: 1.7;
            color: #333;
            font-size: 0.95rem;
        }
        
        .context-box {
            background: #fff9e6;
            border: 1px solid #f0c419;
            padding: 20px;
            margin-bottom: 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .context-box h3 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 700;
        }
        
        .context-box ul {
            margin-left: 20px;
            color: #856404;
        }
        
        .context-box li {
            margin-bottom: 8px;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .context-box strong {
            font-weight: 700;
        }
        
        .controls {
            background: #f5f5f5;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #ddd;
        }
        
        .controls h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #2c3e50;
            font-family: Georgia, serif;
            font-weight: 700;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 0.95rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #2c3e50;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #2c3e50;
            cursor: pointer;
            border: none;
        }
        
        .value-display {
            display: inline-block;
            background: #2c3e50;
            color: white;
            padding: 3px 10px;
            font-weight: 600;
            margin-left: 10px;
            font-size: 0.9rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        button {
            background: #c0392b;
            color: white;
            border: none;
            padding: 14px 35px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
            margin-top: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: #a93226;
        }
        
        button:active {
            background: #922b21;
        }
        
        .results {
            display: none;
        }
        
        .results.visible {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .result-card {
            background: white;
            border: 2px solid #2c3e50;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .result-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            font-family: Georgia, serif;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: 600;
            color: #555;
        }
        
        .stat-value {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.05rem;
        }
        
        .benchmark-context {
            background: #e8f4f8;
            border: 2px solid #3498db;
            padding: 25px;
            margin-bottom: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .benchmark-context h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-family: Georgia, serif;
        }
        
        .benchmark-context p {
            color: #2c3e50;
            line-height: 1.7;
            margin-bottom: 12px;
        }
        
        .benchmark-context ul {
            margin: 15px 0 15px 25px;
            color: #2c3e50;
        }
        
        .benchmark-context li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .benchmark-context strong {
            font-weight: 700;
            color: #c0392b;
        }
        
        .interpretation {
            background: #fff9e6;
            padding: 25px;
            border-left: 4px solid #f0c419;
            margin-top: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .interpretation h3 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-family: Georgia, serif;
        }
        
        .interpretation p {
            color: #856404;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .comparison-card {
            background: #f9f9f9;
            padding: 25px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .comparison-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.05rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .big-number {
            font-size: 3rem;
            font-weight: 700;
            color: #c0392b;
            margin: 15px 0;
            font-family: Georgia, serif;
        }
        
        .sample-meetings {
            background: white;
            padding: 15px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
        
        .sample-meetings h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .meeting-item {
            padding: 8px;
            background: #f9f9f9;
            margin-bottom: 5px;
            font-size: 0.8rem;
            border-left: 3px solid #2c3e50;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #2c3e50;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #c0392b;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .content {
                padding: 25px 20px;
            }
            
            header {
                padding: 25px 20px;
            }
            
            .big-number {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pittsburgh Water and Sewer Authority Board Voting Analysis</h1>
            <p class="subtitle">Interactive Statistical Tool</p>
        </header>
        
        <div class="content">
            <div class="intro">
                <p><strong>About this tool:</strong> This interactive analysis allows you to randomly sample board meeting resolutions from the Pittsburgh Water and Sewer Authority and compare them to peer utilities. Test whether observed voting patterns are statistically unusual.</p>
            </div>
            
            <div class="context-box">
                <h3>Statistical Benchmarks</h3>
                <p>Standard probability calculations reveal the extreme unlikelihood of PWSA's unanimous voting pattern:</p>
                <ul>
                    <li><strong>If board members naturally agreed 90% of the time:</strong> The probability of achieving 215 consecutive unanimous votes is 0.000000015% (one in 6.9 billion)</li>
                    <li><strong>Natural expert variation:</strong> Studies of FDA advisory panels show individual expert error rates of 17.5-27.5% even when analyzing identical information</li>
                    <li><strong>Required agreement rate:</strong> To achieve 215 consecutive unanimous votes would require board members to agree 97%+ of the time—far exceeding normal expert consensus rates</li>
                </ul>
            </div>
            
            <div id="error" class="error" style="display:none;"></div>
            
            <div class="controls">
                <h2>Interactive Test</h2>
                
                <div class="control-group">
                    <label for="sampleSize">
                        Number of random meetings to sample
                        <span class="value-display" id="sampleSizeValue">3</span>
                    </label>
                    <input type="range" id="sampleSize" min="1" max="6" value="3" step="1">
                </div>
                
                <div class="control-group">
                    <label for="expectedRate">
                        Expected unanimous agreement rate (null hypothesis)
                        <span class="value-display" id="expectedRateValue">95%</span>
                    </label>
                    <input type="range" id="expectedRate" min="50" max="100" value="95" step="5">
                </div>
                
                <button id="runTest">Run Random Sample Test</button>
            </div>
            
            <div id="results" class="results">
                <div class="comparison">
                    <div class="comparison-card">
                        <div class="comparison-title">Pittsburgh Water and Sewer Authority</div>
                        <div class="big-number" id="pwsaRate">-</div>
                        <div style="color: #666; font-size: 0.9rem;">unanimous agreement</div>
                        <div class="sample-meetings" id="pwsaSample"></div>
                    </div>
                    
                    <div class="comparison-card">
                        <div class="comparison-title">Peer Water Utilities</div>
                        <div class="big-number" id="peerRate">-</div>
                        <div style="color: #666; font-size: 0.9rem;">unanimous agreement</div>
                        <div class="sample-meetings" id="peerSample"></div>
                    </div>
                </div>
                
                <div class="result-card">
                    <div class="result-header">Sample Results</div>
                    <div class="stat-row">
                        <span class="stat-label">PWSA Sample Size</span>
                        <span class="stat-value" id="pwsaSampleSize">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PWSA Unanimous Votes</span>
                        <span class="stat-value" id="pwsaUnanimousRate">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Peer Sample Size</span>
                        <span class="stat-value" id="peerSampleSize">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Peer Unanimous Votes</span>
                        <span class="stat-value" id="peerUnanimousRate">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Expected Rate (Null Hypothesis)</span>
                        <span class="stat-value" id="expectedRateDisplay">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">P-value (Binomial Test)</span>
                        <span class="stat-value" id="pValue">-</span>
                    </div>
                </div>
                
                <div class="benchmark-context">
                    <h3>How This Compares to Research Benchmarks</h3>
                    <div id="benchmarkComparison"></div>
                </div>
                
                <div class="interpretation" id="interpretation"></div>
            </div>
        </div>
    </div>

    <script>
        let meetingData = null;
        
        // Load the data
        async function loadData() {
            try {
                const response = await fetch('meeting_data.json');
                if (!response.ok) throw new Error('Failed to load data');
                meetingData = await response.json();
                console.log('Data loaded:', meetingData.metadata);
            } catch (error) {
                document.getElementById('error').textContent = 'Error loading data: ' + error.message;
                document.getElementById('error').style.display = 'block';
            }
        }
        
        // Update slider displays
        document.getElementById('sampleSize').addEventListener('input', (e) => {
            document.getElementById('sampleSizeValue').textContent = e.target.value;
        });
        
        document.getElementById('expectedRate').addEventListener('input', (e) => {
            document.getElementById('expectedRateValue').textContent = e.target.value + '%';
        });
        
        // Calculate binomial probability
        function binomialCoefficient(n, k) {
            if (k < 0 || k > n) return 0;
            if (k === 0 || k === n) return 1;
            
            let result = 1;
            for (let i = 1; i <= k; i++) {
                result *= (n - i + 1) / i;
            }
            return result;
        }
        
        function binomialProbability(n, k, p) {
            return binomialCoefficient(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }
        
        function calculatePValue(observed, total, expectedRate) {
            let pValue = 0;
            for (let i = observed; i <= total; i++) {
                pValue += binomialProbability(total, i, expectedRate);
            }
            return pValue;
        }
        
        // Random sampling
        function randomSample(array, size) {
            const shuffled = [...array].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, size);
        }
        
        // Run the test
        document.getElementById('runTest').addEventListener('click', () => {
            if (!meetingData) {
                alert('Data not loaded yet. Please refresh the page.');
                return;
            }
            
            const sampleSize = parseInt(document.getElementById('sampleSize').value);
            const expectedRate = parseInt(document.getElementById('expectedRate').value) / 100;
            
            // Sample PWSA data
            const pwsaSample = randomSample(meetingData.pwsa, sampleSize);
            const pwsaUnanimous = pwsaSample.filter(m => m.vote_outcome === 'unanimous').length;
            const pwsaRate = pwsaSample.length > 0 ? (pwsaUnanimous / pwsaSample.length) : 0;
            
            // Sample peer data
            const peerSample = randomSample(meetingData.peers, sampleSize);
            const peerUnanimous = peerSample.filter(m => m.vote_outcome === 'unanimous').length;
            const peerRate = peerSample.length > 0 ? (peerUnanimous / peerSample.length) : 0;
            
            // Calculate p-value
            const pValue = calculatePValue(pwsaUnanimous, pwsaSample.length, expectedRate);
            
            // Display results
            document.getElementById('pwsaRate').textContent = Math.round(pwsaRate * 100) + '%';
            document.getElementById('peerRate').textContent = Math.round(peerRate * 100) + '%';
            
            document.getElementById('pwsaSampleSize').textContent = pwsaSample.length;
            document.getElementById('pwsaUnanimousRate').textContent = `${pwsaUnanimous}/${pwsaSample.length} (${Math.round(pwsaRate * 100)}%)`;
            
            document.getElementById('peerSampleSize').textContent = peerSample.length;
            document.getElementById('peerUnanimousRate').textContent = `${peerUnanimous}/${peerSample.length} (${Math.round(peerRate * 100)}%)`;
            
            document.getElementById('expectedRateDisplay').textContent = Math.round(expectedRate * 100) + '%';
            document.getElementById('pValue').textContent = pValue.toFixed(4);
            
            // Display sampled meetings - PWSA
            const pwsaSampleDiv = document.getElementById('pwsaSample');
            pwsaSampleDiv.innerHTML = '<h4>Sampled Resolutions:</h4>';
            pwsaSample.forEach(m => {
                const div = document.createElement('div');
                div.className = 'meeting-item';
                div.textContent = `${m.meeting_date} — ${m.vote_outcome} — ${m.notes}`;
                pwsaSampleDiv.appendChild(div);
            });
            
            // Display sampled meetings - Peers
            const peerSampleDiv = document.getElementById('peerSample');
            peerSampleDiv.innerHTML = '<h4>Sampled Resolutions:</h4>';
            peerSample.forEach(m => {
                const div = document.createElement('div');
                div.className = 'meeting-item';
                div.textContent = `${m.meeting_date} — ${m.vote_outcome} — ${m.notes}`;
                peerSampleDiv.appendChild(div);
            });
            
            // Interpretation
            const interpretation = document.getElementById('interpretation');
            let message = '<h3>Interpretation</h3>';
            
            if (pValue < 0.05) {
                message += `<p><strong>This result is statistically significant</strong> (p = ${pValue.toFixed(4)}). There is only a ${(pValue * 100).toFixed(2)}% probability of observing ${pwsaUnanimous} or more unanimous votes out of ${pwsaSample.length} meetings if the true unanimous agreement rate were ${Math.round(expectedRate * 100)}%.</p>`;
                message += `<p>In other words, this pattern is <strong>unlikely to occur by chance alone</strong> under the assumption that board members naturally disagree at typical expert rates.</p>`;
            } else {
                message += `<p>This result is not statistically significant (p = ${pValue.toFixed(4)}). There is a ${(pValue * 100).toFixed(2)}% probability of observing this pattern if the true rate were ${Math.round(expectedRate * 100)}%. This could reasonably occur by chance.</p>`;
            }
            
            const rateDiff = Math.abs(pwsaRate - peerRate);
            if (rateDiff > 0.15) {
                message += `<p><strong>Comparative note:</strong> In this random sample, PWSA's unanimous agreement rate (${Math.round(pwsaRate * 100)}%) ${pwsaRate > peerRate ? 'exceeds' : 'is lower than'} peer utilities (${Math.round(peerRate * 100)}%) by ${Math.round(rateDiff * 100)} percentage points.</p>`;
            }
            
            interpretation.innerHTML = message;
            
            // Add benchmark comparison
            const benchmarkDiv = document.getElementById('benchmarkComparison');
            let benchmarkText = `<p>Your sampled PWSA unanimous rate: <strong>${Math.round(pwsaRate * 100)}%</strong></p>`;
            benchmarkText += `<ul>`;
            benchmarkText += `<li><strong>Peer utilities in this sample:</strong> ${Math.round(peerRate * 100)}% unanimous agreement</li>`;
            benchmarkText += `<li><strong>FDA advisory panels:</strong> Individual expert error rates of 17.5-27.5%, even with identical information (suggesting natural agreement rates around 72.5-82.5%)</li>`;
            benchmarkText += `<li><strong>Statistical threshold:</strong> To achieve 215 consecutive unanimous votes requires 97%+ agreement—far above normal expert consensus</li>`;
            benchmarkText += `</ul>`;
            benchmarkText += `<p style="margin-top: 15px;"><em>Note: Even this small random sample can reveal whether observed patterns are consistent with normal expert variation or suggest an unusually high degree of agreement.</em></p>`;
            benchmarkDiv.innerHTML = benchmarkText;
            
            // Show results
            document.getElementById('results').classList.add('visible');
        });
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>
